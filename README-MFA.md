# Enterprise Multi-Factor Authentication (MFA) System

A comprehensive, production-ready Multi-Factor Authentication system built with Spring Boot, supporting TOTP, WebAuthn/FIDO2, SMS, Email, and backup codes with industry-standard security practices.

## üîê Features

### **Multi-Factor Authentication Methods**
- **üîë TOTP (Time-based One-Time Password)** - Google Authenticator, Authy, 1Password compatible
- **üõ°Ô∏è WebAuthn/FIDO2** - Biometric and hardware security key support
- **üì± SMS Verification** - Rate-limited SMS codes via Twilio/AWS SNS
- **üìß Email Verification** - HTML/text email codes with templates
- **üîÑ Backup Recovery Codes** - Secure one-time recovery codes

### **Security Features**
- **Replay Attack Prevention** - Time-window validation and challenge tracking
- **Rate Limiting** - Per-user and per-IP protection against brute force
- **Device Fingerprinting** - Remember trusted devices for 30 days
- **Step-up Authentication** - Risk-based MFA triggers
- **Comprehensive Audit Logging** - Security event tracking
- **Administrative Override** - Emergency access controls

### **User Experience**
- **Progressive Enrollment** - Step-by-step MFA setup wizard
- **Device Management** - Add/remove/rename authentication devices
- **QR Code Generation** - Easy TOTP app enrollment
- **Graceful Fallbacks** - Multiple authentication options
- **Mobile-Responsive UI** - Works on all devices

## üèóÔ∏è Architecture

### **Core Components**

```
src/main/java/com/enterprise/security/mfa/
‚îú‚îÄ‚îÄ model/          # JPA entities (MfaDevice, MfaChallenge, BackupCode, TrustedDevice)
‚îú‚îÄ‚îÄ repository/     # Data access layer with custom queries
‚îú‚îÄ‚îÄ service/        # Business logic (TOTPService, WebAuthnService, etc.)
‚îú‚îÄ‚îÄ controller/     # REST API endpoints
‚îú‚îÄ‚îÄ config/         # Spring configuration
‚îî‚îÄ‚îÄ utils/          # Utility classes
```

### **Database Schema**

- **mfa_devices** - User's registered MFA devices
- **mfa_challenges** - Active authentication challenges
- **backup_codes** - Recovery codes with usage tracking
- **trusted_devices** - Remembered devices with expiration

## üöÄ Quick Start

### **1. Dependencies**

Add to your `pom.xml`:

```xml
<dependency>
    <groupId>com.enterprise.security</groupId>
    <artifactId>mfa-system</artifactId>
    <version>1.0.0</version>
</dependency>
```

### **2. Configuration**

```yaml
app:
  mfa:
    require-mfa: true
    challenge-validity-minutes: 5
    max-attempts: 3
    trusted-device-days: 30
    
    totp:
      issuer: "Your App Name"
      algorithm: "HmacSHA256"
    
    webauthn:
      rp-id: "yourdomain.com"
      rp-name: "Your App"
    
    sms:
      provider: "twilio"  # or "aws" or "mock"
      twilio:
        account-sid: "${TWILIO_ACCOUNT_SID}"
        auth-token: "${TWILIO_AUTH_TOKEN}"
        from-number: "${TWILIO_FROM_NUMBER}"
    
    email:
      subject-template: "Verification Code for %s"
      use-html: true

spring:
  mail:
    host: smtp.gmail.com
    port: 587
    username: "${SMTP_USERNAME}"
    password: "${SMTP_PASSWORD}"
```

### **3. Database Setup**

```sql
-- Auto-generated by JPA, or run flyway migrations
CREATE TABLE mfa_devices (
    id UUID PRIMARY KEY,
    user_id VARCHAR(255) NOT NULL,
    type VARCHAR(50) NOT NULL,
    device_name VARCHAR(255) NOT NULL,
    encrypted_secret TEXT,
    -- ... other columns
);
```

### **4. Frontend Integration**

Include the JavaScript libraries:

```html
<script src="/js/mfa-enrollment.js"></script>
<script src="/js/mfa-authentication.js"></script>

<div id="mfa-enrollment-container"></div>
<div id="mfa-challenge-container"></div>

<script>
// Initialize MFA enrollment
const mfaEnrollment = new MfaEnrollment();
mfaEnrollment.init();

// Check MFA requirement during login
const mfaAuth = new MfaAuthentication();
mfaAuth.checkMfaRequired(userId, deviceFingerprint);
</script>
```

## üìö API Documentation

### **Enrollment Endpoints**

```http
GET    /api/mfa/enrollment/status           # Get enrollment status
GET    /api/mfa/enrollment/methods          # List available methods
POST   /api/mfa/enrollment/totp/start       # Start TOTP enrollment
POST   /api/mfa/enrollment/totp/complete    # Complete TOTP enrollment
POST   /api/mfa/enrollment/sms/start        # Start SMS enrollment
POST   /api/mfa/enrollment/backup-codes/generate  # Generate backup codes
DELETE /api/mfa/enrollment/device/{id}      # Remove device
```

### **Authentication Endpoints**

```http
GET    /api/mfa/auth/required               # Check if MFA required
POST   /api/mfa/auth/challenge/initiate     # Start MFA challenge
POST   /api/mfa/auth/challenge/verify       # Verify MFA response
POST   /api/mfa/auth/backup-code/verify     # Verify backup code
```

### **WebAuthn Endpoints**

```http
POST   /api/mfa/webauthn/register/platform/start    # Biometric enrollment
POST   /api/mfa/webauthn/register/cross-platform/start  # Security key enrollment
POST   /api/mfa/webauthn/register/finish            # Complete registration
POST   /api/mfa/webauthn/authenticate/start         # Start authentication
POST   /api/mfa/webauthn/authenticate/finish        # Complete authentication
```

## üîß Integration Examples

### **1. OAuth2 Integration**

```java
@Component
public class MfaOAuth2AuthenticationSuccessHandler implements AuthenticationSuccessHandler {
    
    @Autowired
    private MfaService mfaService;
    
    @Override
    public void onAuthenticationSuccess(HttpServletRequest request, 
                                      HttpServletResponse response,
                                      Authentication authentication) throws IOException {
        
        String userId = authentication.getName();
        String deviceFingerprint = extractDeviceFingerprint(request);
        
        if (mfaService.requiresMfa(userId, deviceFingerprint)) {
            // Redirect to MFA challenge page
            response.sendRedirect("/mfa/challenge");
        } else {
            // Continue with normal OAuth2 flow
            response.sendRedirect("/dashboard");
        }
    }
}
```

### **2. API Gateway Integration**

```java
@Component
public class MfaAuthenticationFilter implements Filter {
    
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, 
                        FilterChain chain) throws IOException, ServletException {
        
        HttpServletRequest httpRequest = (HttpServletRequest) request;
        
        // Check if endpoint requires MFA
        if (requiresMfaForEndpoint(httpRequest.getRequestURI())) {
            String authToken = extractAuthToken(httpRequest);
            
            if (!mfaService.isTokenMfaVerified(authToken)) {
                ((HttpServletResponse) response).setStatus(HttpStatus.UNAUTHORIZED.value());
                return;
            }
        }
        
        chain.doFilter(request, response);
    }
}
```

### **3. Step-up Authentication**

```java
@RestController
public class SensitiveOperationsController {
    
    @PostMapping("/api/sensitive-operation")
    @PreAuthorize("@mfaService.requiresStepUpAuth(authentication.name, #operation)")
    public ResponseEntity<?> performSensitiveOperation(@RequestBody Operation operation) {
        
        // Check if recent MFA verification exists
        if (!mfaService.hasRecentMfaVerification(getCurrentUserId(), Duration.ofMinutes(5))) {
            return ResponseEntity.status(HttpStatus.FORBIDDEN)
                .body(Map.of("requiresMfa", true, "reason", "step-up-auth"));
        }
        
        // Proceed with sensitive operation
        return ResponseEntity.ok(operationService.execute(operation));
    }
}
```

## üõ°Ô∏è Security Best Practices

### **1. Secret Management**

```java
@Service
public class SecretEncryptionService {
    
    @Value("${app.mfa.encryption-key}")
    private String encryptionKey;
    
    public String encryptSecret(String plainSecret) {
        // Use AES-256-GCM for encrypting TOTP secrets
        // Store only encrypted versions in database
    }
    
    public String decryptSecret(String encryptedSecret) {
        // Decrypt only when needed for verification
    }
}
```

### **2. Rate Limiting**

```java
@Component
public class MfaRateLimiter {
    
    private final RedisTemplate<String, String> redisTemplate;
    
    public boolean isRateLimited(String userId, String ipAddress) {
        String userKey = "mfa:attempts:user:" + userId;
        String ipKey = "mfa:attempts:ip:" + ipAddress;
        
        return checkRateLimit(userKey, 5, Duration.ofMinutes(15)) ||
               checkRateLimit(ipKey, 20, Duration.ofMinutes(15));
    }
}
```

### **3. Audit Logging**

```java
@EventListener
public class MfaSecurityEventListener {
    
    @Async
    public void handleLoginFailure(MfaLoginFailureEvent event) {
        auditLogger.warn("MFA login failure for user: {}, IP: {}, reason: {}", 
            event.getUserId(), event.getIpAddress(), event.getReason());
        
        // Trigger additional security measures if needed
        if (event.getFailureCount() > 5) {
            securityAlertService.sendAlert(AlertLevel.HIGH, event);
        }
    }
}
```

## üìä Monitoring & Metrics

### **Key Metrics to Track**

- MFA enrollment rates by method
- Authentication success/failure rates
- Average authentication time
- Device trust utilization
- Backup code usage patterns
- Security event frequencies

### **Grafana Dashboard Queries**

```promql
# MFA Authentication Rate
rate(mfa_authentication_total[5m])

# MFA Success Rate
rate(mfa_authentication_success_total[5m]) / rate(mfa_authentication_total[5m])

# Average Authentication Time
histogram_quantile(0.95, rate(mfa_authentication_duration_seconds_bucket[5m]))
```

## üß™ Testing

### **Unit Tests**

```bash
mvn test
```

### **Integration Tests**

```bash
mvn verify -P integration-tests
```

### **Security Tests**

```bash
mvn verify -P security-tests
```

### **Load Testing**

```bash
# Using Artillery.js for API load testing
npm install -g artillery
artillery run tests/load/mfa-load-test.yml
```

## üîß Configuration Reference

### **Required Configuration**

| Property | Description | Default | Required |
|----------|-------------|---------|----------|
| `app.mfa.require-mfa` | Enforce MFA for all users | `true` | No |
| `app.mfa.webauthn.rp-id` | WebAuthn Relying Party ID | `localhost` | Yes |
| `spring.mail.host` | SMTP server for email MFA | - | Yes |

### **SMS Provider Configuration**

```yaml
# Twilio Configuration
app.mfa.sms:
  provider: twilio
  twilio:
    account-sid: ACxxxxx
    auth-token: xxxxx
    from-number: +1234567890

# AWS SNS Configuration
app.mfa.sms:
  provider: aws
  aws:
    access-key: AKIAxxxxx
    secret-key: xxxxx
    region: us-east-1
```

## üö¢ Deployment

### **Docker Deployment**

```dockerfile
FROM openjdk:17-jre-slim

COPY target/mfa-system-1.0.0.jar app.jar
COPY src/main/resources/application-prod.yml application.yml

EXPOSE 8080

ENTRYPOINT ["java", "-jar", "/app.jar"]
```

### **Kubernetes Deployment**

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mfa-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: mfa-service
  template:
    metadata:
      labels:
        app: mfa-service
    spec:
      containers:
      - name: mfa-service
        image: enterprise/mfa-system:1.0.0
        ports:
        - containerPort: 8080
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: "prod"
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: db-secret
              key: url
```

## üîç Troubleshooting

### **Common Issues**

1. **WebAuthn not working**
   - Ensure HTTPS is enabled (required for WebAuthn)
   - Check browser compatibility
   - Verify Relying Party ID matches domain

2. **TOTP codes not validating**
   - Check server time synchronization
   - Verify time window tolerance settings
   - Ensure secret is properly base32 encoded

3. **SMS not sending**
   - Verify Twilio/AWS credentials
   - Check rate limiting settings
   - Confirm phone number format

4. **Email delivery issues**
   - Verify SMTP configuration
   - Check spam/junk folders
   - Test with different email providers

### **Debug Logging**

```yaml
logging:
  level:
    com.enterprise.security.mfa: DEBUG
    org.springframework.security: DEBUG
    com.yubico.webauthn: DEBUG
```

## üìÑ License

This project is licensed under the MIT License - see the [LICENSE](LICENSE) file for details.

## ü§ù Contributing

1. Fork the repository
2. Create a feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## üìû Support

- **Documentation**: [Wiki](wiki)
- **Issues**: [GitHub Issues](issues)
- **Security**: security@enterprise.com
- **General**: support@enterprise.com

---

**Built with ‚ù§Ô∏è for enterprise security**